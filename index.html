<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smartphone Sensing Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%; 
            background: #4f46e5;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            margin-top: -8px; 
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex flex-col items-center p-4 sm:p-8">
        <div id="app-container" class="w-full max-w-4xl bg-white shadow-2xl rounded-2xl p-6 sm:p-10 transition-all duration-300">
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-700 flex items-center justify-center space-x-3">
                    <i data-lucide="camera" class="h-7 w-7 sm:h-8 sm:w-8 text-red-500"></i>
                    <span>Smartphone Sensing Analyzer</span>
                </h1>
                <p class="mt-2 text-md sm:text-lg text-gray-500">
                    Extract RGB, analyze with AI, and track your experiments.
                </p>
            </header>

            <div id="status-container"></div>

            <div class="mb-8 p-6 bg-indigo-50 rounded-xl border border-indigo-200 shadow-inner">
                <label for="file-upload" class="flex flex-col items-center justify-center cursor-pointer p-6 border-4 border-dashed border-indigo-400 rounded-xl hover:border-indigo-600 transition duration-150">
                    <i data-lucide="upload" class="w-8 h-8 text-indigo-500"></i>
                    <span id="file-name" class="mt-2 text-lg font-semibold text-indigo-700">Click to Upload Fluorescence Image</span>
                    <span class="text-sm text-gray-500">PNG or JPEG (max 5MB recommended)</span>
                    <input id="file-upload" type="file" accept="image/*" class="hidden">
                </label>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="flex flex-col space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i data-lucide="camera" class="w-5 h-5 mr-2 text-indigo-500"></i> Image and Measured Data
                    </h2>
                    <div class="p-4 bg-white rounded-lg shadow-md border border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Region of Interest (ROI) Size: <span id="roi-label">15x15</span> pixels
                        </label>
                        <input id="roi-slider" type="range" min="5" max="40" step="5" value="15" class="w-full h-2 bg-indigo-100 rounded-lg appearance-none cursor-pointer range-lg">
                    </div>
                    <div id="image-preview-container" class="relative w-full aspect-[4/3] bg-gray-200 rounded-xl flex items-center justify-center text-gray-500 italic border-4 border-dashed border-gray-400">
                        Image Preview
                    </div>
                    <canvas id="processing-canvas" style="display: none;"></canvas>
                    <div id="rgb-display" class="flex justify-around p-4 bg-gray-50 rounded-xl shadow-md border">
                        </div>
                </div>

                <div class="flex flex-col space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i data-lucide="zap" class="w-5 h-5 mr-2 text-red-500"></i> AI-Enhanced Prediction
                    </h2>
                    <button id="predict-button" class="w-full flex justify-center items-center py-3 px-6 text-lg font-semibold rounded-xl shadow-lg transition duration-300 transform bg-indigo-300 text-white cursor-not-allowed">
                        <i data-lucide="shield-check" class="w-5 h-5 mr-2"></i> Estimate Intensity
                    </button>
                    <div class="p-5 bg-white rounded-xl shadow-xl border border-gray-200 min-h-[170px] flex flex-col justify-center">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700 flex items-center">
                            <i data-lucide="file-text" class="w-5 h-5 mr-2 text-teal-500"></i> Prediction Summary
                        </h3>
                        <div id="prediction-summary">
                             <p class="text-gray-400 italic text-center">
                                Upload an image and click "Estimate Intensity" to see the AI analysis here.
                            </p>
                        </div>
                    </div>
                    <div id="save-button-container"></div>
                    <div id="protocol-generator-container"></div>
                </div>
            </div>

            <hr class="my-10 border-gray-300" />
            <div class="w-full">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-6">
                    <i data-lucide="database" class="w-6 h-6 mr-3 text-indigo-500"></i> Experimental History (<span id="history-count">0</span>)
                </h2>
                <div class="bg-gray-100 p-4 rounded-xl shadow-inner max-h-96 overflow-y-auto">
                    <div id="history-list">
                         <p class="text-gray-500 italic text-center py-8">
                            No results saved yet. Analyze an image and click "Save Result to History."
                            <span id="user-id-display" class="block mt-2 text-xs"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <footer class="mt-8 text-center text-gray-400 text-sm">
            <p id="app-id-display"></p>
            <p>This is a demonstration of AI-enhanced Materials Modeling 2.0 using the Gemini API.</p>
        </footer>
    </div>
    
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, deleteDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const DOMElements = {
            fileInput: document.getElementById('file-upload'),
            fileNameDisplay: document.getElementById('file-name'),
            roiSlider: document.getElementById('roi-slider'),
            roiLabel: document.getElementById('roi-label'),
            imagePreviewContainer: document.getElementById('image-preview-container'),
            canvas: document.getElementById('processing-canvas'),
            rgbDisplay: document.getElementById('rgb-display'),
            predictButton: document.getElementById('predict-button'),
            predictionSummary: document.getElementById('prediction-summary'),
            saveButtonContainer: document.getElementById('save-button-container'),
            protocolGeneratorContainer: document.getElementById('protocol-generator-container'),
            historyList: document.getElementById('history-list'),
            historyCount: document.getElementById('history-count'),
            statusContainer: document.getElementById('status-container'),
            userIdDisplay: document.getElementById('user-id-display'),
            appIdDisplay: document.getElementById('app-id-display'),
        };

        // --- App State ---
        let state = {
            file: null,
            previewUrl: '',
            base64Image: '',
            rgb: { r: 0, g: 0, b: 0 },
            aiResult: null,
            protocol: '',
            isLoading: false,
            isProtocolLoading: false,
            isAuthReady: false,
            roiSize: 15,
            samplePos: { x: 50, y: 50 },
            db: null,
            auth: null,
            userId: null,
            savedResults: [],
        };
        
        // --- API & Firebase Config ---
        // 1. HARDCODED API KEY (Correct)
        const USER_GEMINI_API_KEY = "AIzaSyCOZH6F6lZoY0LqID-dkkEI37uSBZVJSyA"; 

        const inCanvas = typeof __firebase_config !== 'undefined';
        
        // 2. HARDCODED MODEL URL (Corrected to Gemini 1.5 Flash)
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${USER_GEMINI_API_KEY}`;

        const appId = inCanvas ? (typeof __app_id !== 'undefined' ? __app_id : 'default-canvas-app-id') : "external-sensing-app"; 
        DOMElements.appIdDisplay.textContent = `Application ID: ${appId}`;
        
        const USER_FIREBASE_CONFIG = {
            apiKey:
